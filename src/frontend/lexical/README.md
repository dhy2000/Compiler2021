# 词法分析

词法分析代码位于 `frontend.lexical` 包中，包括词语类，词语列表以及词法分析器类。 词法分析实现起来较为简单，该环节将源代码文件中字符串形式的代码拆分成词语，并将分析出的词语成分存在一个 `List` 中用于语法分析。

## 输入文件处理

进行词法分析前首先读取输入文件，在本编译器的设计中，出于后续错误处理需要保留行号，且词法分析的到的词语单元不会跨多行，因此将输入的源代码逐行读入，按行存储。为了便于进行词法分析，针对按行存储的源代码设计了一个类，并维护了当前所读到的行和列。在进行词法分析时只需传递这个类的对象并读取出内容即可。

## 词语成分存储

在本编译器中针对词语成分建立了类来存储，包括一个抽象的基类和若干子类表示不同的词语成分。同时定义了一个枚举类型用来标识当前词法成分的种类。由于 Java 语言的枚举类型功能较为强大，并不只是一个符号而是一个对象，因此可以在枚举类的实例中存储一个代表当前词法匹配规则的正则表达式。

对于具体的一个词语，其存储类存储了当前词语的种类(枚举类), 当前词语的内容，以及所在的行号。

观察词语表，前三种词语 `Ident`, `IntConst`, `FormatString` 具有一定的灵活性(含有有意义的值)，而其他的词语成分仅有结构上的作用，内容是固定的（例如关键词和运算符），因此将前三种词语分别定义类，而所有的关键词和符号统一定义一个类即可。

## 词法分析器

设计完词语的存储类后就是词法分析器的编写。词法分析器的大体工作流程为：

- 如果已经到了输入的末尾，则结束
- 跳过当前位置往后的空白符号，找到第一个非空白符
- 如果面前是注释，则跳过注释，而后继续循环读入
- 否则依次用枚举类中定义过的词法成分进行正则匹配，匹配到则实例化词语类并存入词语列表

根据上述流程即可编写出词法分析器的代码，设计和编码的过程不太困难，故不在此赘述。

## 需要注意的事项

在编写词法分析器的过程中遇到了一些比较容易错的点，在此记录：

- 对于块注释，匹配完起始符号 `/*` 后应跳过 2 个字符而不是 1 个字符，否则如遇到 `/*/` 则会错误识别到 `*/` 而提前结束注释。
- 双字符的运算符匹配顺序应先于单字符运算符（有公共前缀，例如 `==` 应匹配为双等号而非两个单等号，即**贪心匹配**）
- 同理，可能存在一些标识符以关键词作为前缀，例如 `inta`，不能错误匹配出 `int` （同样需满足贪心匹配的原则）
  - 该问题的解决方法有两种，一种是首先匹配出一个 `Ident`，再进行关键词的判断
  - 二是统一采用正则表达式，但是对于关键词的匹配规则需加入后置断言（关键词后不能有数字/字母/下划线从而连成一整个标识符），例如 `int(?![_A-Za-z0-9])`

至此，词法分析环节的设计与编码便完成了。